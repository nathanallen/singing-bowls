<!DOCTYPE html>
<html>
<head>
  <title>Serial Connect</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/oscillator.js"></script>


  <style type="text/css">
    body {
      height: 100vmin;
      width: 100vmin;
    }
    nav {
      position: fixed;
      bottom: 10px;
      right: 10px;
    }
    div {
      min-height: 5px;
      width: .5px;
      float: left;
      background-color: black;
    }

    div:hover {
      background-color: blue;
    }
    div:hover::before {
      content: attr(data-freq);
      display: inline-block;
      color: black;
      background-color: yellow;
      margin-top: 5em;
      z-index: 1;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="STOP=false;runFreqs();">Run Test</button>
    <button onclick="STOP=true;sample.changeFrequency(window.loudestFreq)">Resonance Point</button>
  </nav>

  <script>
    var sample = new Osc();
    sample.play();
    sample.changeFrequency(0)

    window.loudestFreq = 0;

    // var filteredAmplitude = (function (){
    //   var running_average = 5;
    //   var amplitudes = [];
    //   var i = -1;
    //   var samples = 127;
    //   return function filteredAmplitude() {
    //     if(i > samples) {
    //       i = 0;
    //       var totals = amplitudes.reduce(function(acc, v){
    //         return acc + v;
    //       }, 0) / amplitudes.length;
    //       running_average = Math.floor( (running_average + totals) / 2 );
    //     }
    //     amplitudes[i] = window.amplitude;
    //     i++;
    //     return running_average;
    //   }
    // }())

    function AudioIn() {
      this.running_min = 0;
      this.running_max = 0;
      this.running_avg  = 0;
      this.samples = [];
      this.num_samples = 128;
      this.samples_idx = 0;
    }
    AudioIn.prototype.incoming = function(gain){
      if(this.samples_idx >= this.num_samples) {
        this.samples_idx = 0;

        var totals = this.samples.reduce(function(acc, v){
          return acc + v;
        }, 0) / this.num_samples;

        this.running_avg = Math.floor( (this.running_avg + totals) / 2 );
      }
      this.samples[this.samples_idx] = gain || window.amplitude;
      this.samples_idx++;

      if (gain < this.running_min) { this.running_min = gain };
      if (gain > this.running_max) { this.running_max = gain };
    }
    AudioIn.prototype.runningAverage = function(){
      return this.running_avg;
    }
    AudioIn.prototype.currentAmplitude = function(){
      return this.samples[this.samples_idx-1];
    }
    AudioIn.prototype.sample = function() {
      var amp = this.currentAmplitude(),
          avg = this.runningAverage(),
          good_sample = true;

      if (amp <= avg/5 ) {
        console.log("too low", amp)
        good_sample = false;
      } else if (amp >= avg*5) {
        console.log("too high", amp)
        good_sample = false;
      }

      return {
        amplitude: this.currentAmplitude(),
        avg: this.runningAverage(),
        max: this.running_max,
        min: this.running_min,
        good_sample: good_sample
      }
    };

    var audioIn = new AudioIn();


    function runFreqs(stepSize=1, offset=440, max=880){
      var amplitude = 0;
      loudestFreq = 0;
      var loudestAmp = 0;
      var averageAmp = 100;
      var freq = stepSize < 0 ? max : offset;

      sample.changeFrequency(freq);

      INTERVAL = setInterval(nextFreq, 20)



      var stop = false;
      function nextFreq() {
        if(stop || window.STOP) return;  // TODO: buggy

        var heard = audioIn.sample();
        if(!heard.good_sample) { return; }

        var amp = heard.amplitude;
        sample.changeFrequency(freq);

        // console.log(freq, amp);
        if(amp > loudestAmp) {
          loudestAmp = amp;
          loudestFreq = freq;
        }

        var el = document.querySelector(`[data-freq="${freq}"]`);
        if(el) {
          el.setAttribute("style", `height:${amp*2}px;`)
        } else {
          document.body.innerHTML += `<div style="height:${amp*2}px;" data-freq="${freq}"></div>`
        }

        freq+=stepSize;

        if(freq > max || freq < offset) {
          stop = true;
          sample.stop();
          clearInterval(INTERVAL); // TODO: buggy
          console.log("loudestFreq:", loudestFreq, loudestAmp);
          console.log("averageAmp:", heard.avg);
          // runFreqs(stepSize*-1);
        }
      }
    }

    var socket = io();
    socket.on('data', function(data) {
      audioIn.incoming(+data);
      // window.amplitude = +data;
      // document.body.innerText = data;
    });
    socket.on('error', function() {
      console.error(arguments)
    });
  </script>

</body>
</html>
