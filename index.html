<!DOCTYPE html>
<html>
<head>
  <title>Serial Connect</title>
  <script src="/socket.io/socket.io.js"></script>
  <style type="text/css">
    body {
      height: 100vmin;
      width: 100vmin;
    }
    nav {
      position: fixed;
      bottom: 10px;
      right: 10px;
    }
    div {
      min-height: 5px;
      width: .5px;
      float: left;
      background-color: black;
    }

    div:hover {
      background-color: blue;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="STOP=false;runFreqs();">Run Test</button>
    <button onclick="STOP=true;sample.changeFrequency(window.loudestFreq)">Resonance Point</button>
  </nav>

  <script type="text/javascript">
  // Start off by initializing a new context.
  context = new (window.AudioContext || window.webkitAudioContext)();

  if (!context.createGain)
    context.createGain = context.createGainNode;
  if (!context.createDelay)
    context.createDelay = context.createDelayNode;
  if (!context.createScriptProcessor)
    context.createScriptProcessor = context.createJavaScriptNode;


  function Osc() {
    this.isPlaying = true;
  }

  Osc.prototype.play = function() {
    this.oscillator = context.createOscillator();
    this.oscillator.connect(context.destination);

    this.oscillator[this.oscillator.start ? 'start' : 'noteOn'](0);
  };

  Osc.prototype.stop = function() {
    this.oscillator.stop(0);
  };

  Osc.prototype.toggle = function() {
    (this.isPlaying ? this.stop() : this.play());
    this.isPlaying = !this.isPlaying;
  };

  Osc.prototype.changeFrequency = function(val) {
    this.oscillator.frequency.value = val;
  };

  Osc.prototype.changeDetune = function(val) {
    this.oscillator.detune.value = val;
  };

  Osc.prototype.changeType = function(type) {
    this.oscillator.type = type;
  };

  </script>

  <script>
    var sample = new Osc();
    sample.play();
    sample.changeFrequency(0)
    // runFreqs();

    window.loudestFreq = 0;

    var filteredAmplitude = (function (){
      var running_average = 20;
      var amplitudes = [];
      var i = -1;
      var samples = 127;
      return function filteredAmplitude() {
        if(i > samples) {
          i = 0;
          var totals = amplitudes.reduce(function(acc, v){
            return acc + v;
          }, 0) / amplitudes.length;
          running_average = Math.floor( (running_average + totals) / 2 );
        }
        amplitudes[i] = window.amplitude;
        i++;
        return running_average;
      }
    }())

    function runFreqs(stepSize=1, offset=130, max=390){
      var amplitude = 0;
      loudestFreq = 0;
      var loudestAmp = 0;
      var averageAmp = 100;
      var i = stepSize < 0 ? max : offset;

      sample.changeFrequency(i+offset);

      INTERVAL = setInterval(nextFreq, 20)



      var stop = false;
      function nextFreq() {
        if(stop || window.STOP) return;  // TODO: buggy
        var amp = window.amplitude;

        var avg = filteredAmplitude();
        if (amp <= avg/3) {
          console.log("too low", amp)
          return;
        } else if (amp >= avg*3) {
          console.log("too high", amp)
          return;
        }

        averageAmp = avg //Math.floor( (averageAmp + amp)/2 );


        var freq = i+offset;
        sample.changeFrequency(i+offset);

        // console.log(freq, amp);
        if(amp > loudestAmp) {
          loudestAmp = amp;
          loudestFreq = freq;
        }

        var el = document.querySelector(`[data-freq="${freq}"]`);
        if(el) {
          el.setAttribute("style", `height:${amp*2}px;`)
        } else {
          document.body.innerHTML += `<div style="height:${amp*2}px;" data-freq="${freq}"></div>`
        }

        i+=stepSize;

        if(i > max || i < offset) {
          stop = true;
          clearInterval(INTERVAL); // TODO: buggy
          console.log("loudestFreq:", loudestFreq, loudestAmp);
          console.log("averageAmp:", averageAmp);
          runFreqs(stepSize*-1);
        }
      }
    }

    var socket = io();
    socket.on('data', function(data) {
      window.amplitude = +data;
      // document.body.innerText = data;
    });
    socket.on('error', function() {
      console.error(arguments)
    });
  </script>

</body>
</html>
